<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dispatch</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg:       #080808;
    --surface:  #0f0f0f;
    --border:   #1c1c1c;
    --text:     #d4d4d8;
    --dim:      #52525b;
    --dimmer:   #27272a;
    --input-bg: #141414;

    --jobs:   #3b82f6;
    --build:  #f97316;
    --learn:  #22c55e;
    --home:   #eab308;
    --write:  #a855f7;
    --self:   #f43f5e;
  }

  html, body {
    height: 100%;
    background: var(--bg);
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
    font-size: 13px;
    overflow: hidden;
  }

  /* ── Header ── */
  header {
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 16px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    flex-shrink: 0;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .brand {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.2em;
    color: var(--text);
  }

  .brand-diamond {
    width: 14px; height: 14px;
    background: var(--text);
    transform: rotate(45deg);
    flex-shrink: 0;
  }

  .vault-status {
    font-size: 10px;
    color: var(--dim);
    letter-spacing: 0.1em;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
  }

  .header-actions { display: flex; gap: 8px; align-items: center; }

  .btn {
    padding: 5px 12px;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.15em;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--dim);
    border-radius: 4px;
    cursor: pointer;
    transition: border-color 0.15s, color 0.15s;
  }
  .btn:hover { border-color: var(--text); color: var(--text); }
  .btn.primary {
    border-color: var(--text);
    color: var(--text);
  }
  .btn.primary:hover { background: var(--dimmer); }

  /* ── Main grid ── */
  .lanes {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    height: calc(100vh - 48px);
    overflow-x: auto;
  }

  /* ── Lane column ── */
  .lane {
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--border);
    min-width: 200px;
    position: relative;
    overflow: hidden;
  }
  .lane:last-child { border-right: none; }

  .lane-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    border-top: 2px solid var(--lane-color);
    position: sticky;
    top: 0;
    z-index: 5;
    background: var(--surface);
  }

  .agent-icon {
    width: 28px; height: 28px;
    border-radius: 50%;
    background: color-mix(in srgb, var(--lane-color) 15%, transparent);
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    color: var(--lane-color);
  }
  .agent-icon svg { width: 15px; height: 15px; }

  .lane-meta { flex: 1; min-width: 0; }
  .lane-name {
    font-size: 10px;
    font-weight: 800;
    letter-spacing: 0.2em;
    color: var(--lane-color);
  }
  .lane-desc {
    font-size: 9px;
    color: var(--dim);
    margin-top: 1px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .lane-clear {
    font-size: 9px;
    color: var(--dimmer);
    background: none;
    border: none;
    cursor: pointer;
    padding: 2px 4px;
    border-radius: 3px;
    transition: color 0.15s;
  }
  .lane-clear:hover { color: var(--dim); }

  /* ── Messages ── */
  .messages {
    flex: 1;
    min-height: 0;
    overflow-y: auto;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    scroll-behavior: smooth;
  }
  .messages::-webkit-scrollbar { width: 3px; }
  .messages::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 2px;
  }

  .message { max-width: 100%; }

  .message.user {
    align-self: flex-end;
  }
  .message.user .bubble {
    background: var(--dimmer);
    color: var(--text);
    padding: 7px 10px;
    border-radius: 10px 10px 2px 10px;
    font-size: 12px;
    line-height: 1.5;
    max-width: 85%;
    word-break: break-word;
  }

  .message.agent { align-self: flex-start; width: 100%; }
  .message.agent .bubble {
    color: var(--text);
    font-size: 12px;
    line-height: 1.6;
    padding: 4px 0;
    word-break: break-word;
  }

  /* Markdown rendering */
  .bubble h1, .bubble h2, .bubble h3 {
    font-size: 12px;
    font-weight: 700;
    margin: 10px 0 4px;
    color: var(--text);
  }
  .bubble h1 { color: var(--lane-color); font-size: 13px; }
  .bubble strong { color: var(--text); font-weight: 700; }
  .bubble em { font-style: italic; color: var(--dim); }
  .bubble code {
    font-family: "JetBrains Mono", "Fira Code", monospace;
    font-size: 11px;
    background: var(--dimmer);
    padding: 1px 5px;
    border-radius: 3px;
    color: var(--lane-color);
  }
  .bubble ul, .bubble ol {
    padding-left: 16px;
    margin: 4px 0;
  }
  .bubble li { margin: 2px 0; }
  .bubble p { margin: 4px 0; }
  .bubble hr {
    border: none;
    border-top: 1px solid var(--border);
    margin: 8px 0;
  }

  .cursor {
    display: inline-block;
    width: 7px; height: 13px;
    background: var(--lane-color);
    vertical-align: text-bottom;
    animation: blink 0.8s step-end infinite;
    border-radius: 1px;
    margin-left: 1px;
    opacity: 0.8;
  }
  @keyframes blink { 50% { opacity: 0; } }

  /* ── Input area ── */
  .input-area {
    border-top: 1px solid var(--border);
    padding: 8px 10px;
    display: flex;
    align-items: center;
    gap: 6px;
    flex-shrink: 0;
    background: var(--input-bg);
  }

  .input-area textarea {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: var(--text);
    font-size: 12px;
    font-family: inherit;
    caret-color: var(--lane-color);
    resize: none;
    overflow: hidden;
    line-height: 1.5;
    max-height: 120px;
    overflow-y: auto;
    padding: 0;
  }
  .input-area textarea::placeholder { color: var(--dimmer); }

  .send-btn {
    width: 22px; height: 22px;
    background: none;
    border: none;
    cursor: pointer;
    color: var(--dimmer);
    display: flex; align-items: center; justify-content: center;
    border-radius: 4px;
    transition: color 0.15s;
    flex-shrink: 0;
    padding: 0;
  }
  .send-btn:hover { color: var(--lane-color); }
  .send-btn svg { width: 14px; height: 14px; }

  /* ── Standup overlay ── */
  .overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.85);
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
  }

  .overlay-panel {
    width: min(760px, 90vw);
    max-height: 80vh;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .overlay-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .overlay-title {
    font-size: 11px;
    font-weight: 800;
    letter-spacing: 0.2em;
    color: var(--text);
  }

  .overlay-date {
    font-size: 10px;
    color: var(--dim);
    margin-left: 12px;
  }

  .overlay-close {
    background: none;
    border: none;
    color: var(--dim);
    cursor: pointer;
    font-size: 16px;
    line-height: 1;
    padding: 2px 6px;
    border-radius: 4px;
    transition: color 0.15s;
  }
  .overlay-close:hover { color: var(--text); }

  .overlay-content {
    flex: 1;
    overflow-y: auto;
    padding: 18px 20px;
    font-size: 13px;
    line-height: 1.7;
    color: var(--text);
  }
  .overlay-content::-webkit-scrollbar { width: 3px; }
  .overlay-content::-webkit-scrollbar-thumb { background: var(--border); }

  /* Markdown in overlay */
  .overlay-content h1, .overlay-content h2 {
    font-size: 13px; font-weight: 700;
    margin: 14px 0 6px; color: var(--text);
  }
  .overlay-content h3 { font-size: 12px; font-weight: 600; margin: 10px 0 4px; color: var(--dim); }
  .overlay-content strong { font-weight: 700; }
  .overlay-content ul, .overlay-content ol { padding-left: 18px; margin: 6px 0; }
  .overlay-content li { margin: 3px 0; }
  .overlay-content p { margin: 6px 0; }
  .overlay-content hr { border: none; border-top: 1px solid var(--border); margin: 12px 0; }
  .overlay-content code {
    font-family: monospace; font-size: 11px;
    background: var(--dimmer); padding: 1px 5px; border-radius: 3px;
  }

  /* Empty state */
  .empty-hint {
    color: var(--dimmer);
    font-size: 11px;
    text-align: center;
    margin-top: 20px;
    line-height: 1.8;
  }

  /* ── Tool action pills ── */
  .tool-actions {
    display: flex;
    flex-direction: column;
    gap: 3px;
    margin-bottom: 6px;
  }

  .tool-pill {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.04em;
    padding: 3px 8px;
    border-radius: 3px;
    width: fit-content;
    font-family: "JetBrains Mono", "Fira Code", monospace;
  }

  .tool-pill.working {
    color: var(--dim);
    background: var(--dimmer);
    animation: pill-pulse 1.2s ease-in-out infinite;
  }

  .tool-pill.done {
    color: #22c55e;
    background: color-mix(in srgb, #22c55e 10%, transparent);
  }

  .tool-pill.error {
    color: #f43f5e;
    background: color-mix(in srgb, #f43f5e 10%, transparent);
  }

  @keyframes pill-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.45; }
  }

  /* History divider */
  .history-divider {
    text-align: center;
    font-size: 9px;
    letter-spacing: 0.12em;
    color: var(--dimmer);
    padding: 6px 0 10px;
    position: relative;
  }
  .history-divider::before, .history-divider::after {
    content: '';
    position: absolute;
    top: 50%;
    width: 28%;
    height: 1px;
    background: var(--border);
  }
  .history-divider::before { left: 0; }
  .history-divider::after  { right: 0; }

  /* Standup */
  .standup-label {
    display: inline-block;
    font-size: 8px;
    font-weight: 800;
    letter-spacing: 0.2em;
    color: var(--lane-color);
    background: color-mix(in srgb, var(--lane-color) 10%, transparent);
    border: 1px solid color-mix(in srgb, var(--lane-color) 25%, transparent);
    padding: 1px 5px;
    border-radius: 3px;
    margin-bottom: 6px;
    margin-right: 4px;
    vertical-align: middle;
  }

  .standup-waiting {
    color: var(--dim);
    font-size: 12px;
    padding: 8px 0;
  }

  .overlay-footer {
    padding: 10px 18px;
    border-top: 1px solid var(--border);
    min-height: 36px;
    flex-shrink: 0;
  }

  .saved-badge {
    font-size: 10px;
    color: #22c55e;
    letter-spacing: 0.05em;
  }
  .saved-badge code {
    font-family: monospace;
    font-size: 10px;
    color: var(--dim);
    background: var(--dimmer);
    padding: 1px 5px;
    border-radius: 3px;
  }
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="brand-diamond"></div>
    DISPATCH
  </div>
  <span class="vault-status" id="vaultStatus">connecting...</span>
  <div class="header-actions">
    <button id="standupBtn" class="btn primary" onclick="runStandup()">STANDUP</button>
  </div>
</header>

<main class="lanes" id="lanes"></main>

<!-- Standup overlay -->
<div class="overlay" id="standupOverlay" style="display:none" onclick="overlayClickOutside(event)">
  <div class="overlay-panel">
    <div class="overlay-header">
      <div style="display:flex;align-items:center">
        <span class="overlay-title">DISPATCH STANDUP</span>
        <span class="overlay-date" id="standupDate"></span>
      </div>
      <button class="overlay-close" onclick="closeStandup()">✕</button>
    </div>
    <div class="overlay-content" id="standupContent"></div>
    <div class="overlay-footer" id="standupFooter"></div>
  </div>
</div>

<script>
// ── Lane config ───────────────────────────────────────────────────────────────
const LANES = [
  { id: 'jobs',  name: 'JOBS',  desc: 'Applications & contacts',  color: '#3b82f6' },
  { id: 'build', name: 'BUILD', desc: 'Projects & making',        color: '#f97316' },
  { id: 'learn', name: 'LEARN', desc: 'Skills & courses',         color: '#22c55e' },
  { id: 'home',  name: 'HOME',  desc: 'House & property',         color: '#eab308' },
  { id: 'write', name: 'WRITE', desc: 'Writing pipeline',         color: '#a855f7' },
  { id: 'self',  name: 'SELF',  desc: 'Health & motivation',      color: '#f43f5e' },
];

// ── Person SVG icon ───────────────────────────────────────────────────────────
const personSVG = `
<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <circle cx="12" cy="8" r="4" fill="currentColor"/>
  <path d="M4 20c0-4.418 3.582-8 8-8s8 3.582 8 8" fill="currentColor"/>
</svg>`;

// Send icon
const sendSVG = `
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
     stroke-linecap="round" stroke-linejoin="round">
  <line x1="22" y1="2" x2="11" y2="13"/>
  <polygon points="22 2 15 22 11 13 2 9 22 2"/>
</svg>`;

// ── Build DOM ─────────────────────────────────────────────────────────────────
function buildUI() {
  const container = document.getElementById('lanes');
  LANES.forEach(lane => {
    const col = document.createElement('div');
    col.className = 'lane';
    col.id = `lane-${lane.id}`;
    col.style.setProperty('--lane-color', lane.color);

    col.innerHTML = `
      <div class="lane-header">
        <div class="agent-icon">${personSVG}</div>
        <div class="lane-meta">
          <div class="lane-name">${lane.name}</div>
          <div class="lane-desc">${lane.desc}</div>
        </div>
        <button class="lane-clear" title="Clear history" onclick="clearLane('${lane.id}')">✕</button>
      </div>
      <div class="messages" id="messages-${lane.id}">
        <div class="empty-hint">Ask anything about ${lane.name.toLowerCase()}.</div>
      </div>
      <div class="input-area">
        <textarea
          id="input-${lane.id}"
          placeholder="Message ${lane.name.toLowerCase()}..."
          onkeydown="handleKey(event, '${lane.id}')"
          oninput="autoResize(this)"
          autocomplete="off"
          spellcheck="false"
          rows="1"
        ></textarea>
        <button class="send-btn" onclick="sendMessage('${lane.id}')" title="Send">
          ${sendSVG}
        </button>
      </div>
    `;
    container.appendChild(col);
  });
}

// ── Minimal markdown renderer ─────────────────────────────────────────────────
function renderMarkdown(raw) {
  let html = raw
    // escape HTML entities first
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    // headings
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
    .replace(/^# (.+)$/gm, '<h1>$1</h1>')
    // bold/italic
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    // inline code
    .replace(/`(.+?)`/g, '<code>$1</code>')
    // horizontal rule
    .replace(/^---$/gm, '<hr>')
    // bullet lists — collect contiguous li lines into ul
    .replace(/((?:^[-*] .+\n?)+)/gm, (block) => {
      const items = block.trim().split('\n')
        .map(l => `<li>${l.replace(/^[-*] /, '')}</li>`).join('');
      return `<ul>${items}</ul>`;
    })
    // numbered lists
    .replace(/((?:^\d+\. .+\n?)+)/gm, (block) => {
      const items = block.trim().split('\n')
        .map(l => `<li>${l.replace(/^\d+\. /, '')}</li>`).join('');
      return `<ol>${items}</ol>`;
    })
    // paragraphs — double newline
    .replace(/\n\n/g, '</p><p>')
    // single newlines
    .replace(/\n/g, '<br>');

  return `<p>${html}</p>`;
}

// ── Message rendering ─────────────────────────────────────────────────────────
function addUserMessage(laneId, text) {
  const msgs = document.getElementById(`messages-${laneId}`);
  // Remove empty hint
  const hint = msgs.querySelector('.empty-hint');
  if (hint) hint.remove();

  const div = document.createElement('div');
  div.className = 'message user';
  div.innerHTML = `<div class="bubble">${escapeHtml(text)}</div>`;
  msgs.appendChild(div);
  scrollBottom(msgs);
}

function addAgentMessage(laneId) {
  const msgs = document.getElementById(`messages-${laneId}`);
  const div = document.createElement('div');
  div.className = 'message agent';
  div.innerHTML = `
    <div class="bubble">
      <div class="tool-actions"></div>
      <div class="agent-text"></div>
      <span class="cursor"></span>
    </div>`;
  msgs.appendChild(div);
  scrollBottom(msgs);
  return div.querySelector('.bubble');
}

function scrollBottom(el) {
  el.scrollTop = el.scrollHeight;
}

function escapeHtml(text) {
  return text
    .replace(/&/g, '&amp;').replace(/</g, '&lt;')
    .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// ── Send + stream ─────────────────────────────────────────────────────────────
async function sendMessage(laneId) {
  const input = document.getElementById(`input-${laneId}`);
  const text = input.value.trim();
  if (!text) return;

  input.value = '';
  input.style.height = 'auto';
  input.disabled = true;

  addUserMessage(laneId, text);
  const bubble = addAgentMessage(laneId);
  const actionsEl = bubble.querySelector('.tool-actions');
  const textEl    = bubble.querySelector('.agent-text');

  let buffer = '';

  try {
    const res = await fetch(`/api/chat/${laneId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: text }),
    });

    if (!res.ok) throw new Error(`Server error: ${res.status}`);

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    const msgs = document.getElementById(`messages-${laneId}`);

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      const raw = decoder.decode(value, { stream: true });
      const lines = raw.split('\n');

      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        try {
          const data = JSON.parse(line.slice(6));

          if (data.tool_working) {
            const pill = document.createElement('div');
            pill.className = 'tool-pill working';
            const n = data.tool_working.name;
            const inp = data.tool_working.input || {};
            if (n === 'create_note') {
              pill.textContent = `↳ creating ${inp.lane || '?'} / ${inp.title || '…'}`;
            } else if (n === 'update_note') {
              pill.textContent = `↳ updating ${inp.path || '…'}`;
            } else if (n === 'list_notes') {
              pill.textContent = `↳ listing ${inp.lane || '?'}…`;
            } else {
              pill.textContent = `↳ ${n}…`;
            }
            pill.dataset.tool = n + JSON.stringify(inp);
            actionsEl.appendChild(pill);
            scrollBottom(msgs);
          }

          if (data.tool_done) {
            // Find the last working pill and resolve it
            const pills = actionsEl.querySelectorAll('.tool-pill.working');
            const pill = pills[pills.length - 1];
            if (pill) {
              if (data.tool_done.success) {
                pill.className = 'tool-pill done';
                pill.textContent = data.tool_done.path
                  ? `✓ ${data.tool_done.path}`
                  : `✓ ${data.tool_done.message}`;
              } else {
                pill.className = 'tool-pill error';
                pill.textContent = `✗ ${data.tool_done.message}`;
              }
            }
            scrollBottom(msgs);
          }

          if (data.text) {
            buffer += data.text;
            textEl.innerHTML = renderMarkdown(buffer);
            scrollBottom(msgs);
          }

          if (data.error) {
            textEl.innerHTML = `<em style="color:#f43f5e">${data.error}</em>`;
          }
        } catch {}
      }
    }
  } catch (err) {
    textEl.innerHTML = `<em style="color:#f43f5e">Connection error: ${err.message}</em>`;
  } finally {
    const cursor = bubble.querySelector('.cursor');
    if (cursor) cursor.remove();
    input.disabled = false;
    input.focus();
  }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

function handleKey(e, laneId) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage(laneId);
  }
}

async function clearLane(laneId) {
  await fetch(`/api/history/${laneId}`, { method: 'DELETE' });
  const msgs = document.getElementById(`messages-${laneId}`);
  msgs.innerHTML = `<div class="empty-hint">Ask anything about ${laneId}.</div>`;
}

// ── Standup ───────────────────────────────────────────────────────────────────
async function runStandup() {
  const overlay = document.getElementById('standupOverlay');
  const content = document.getElementById('standupContent');
  const dateEl  = document.getElementById('standupDate');
  const btn     = document.getElementById('standupBtn');

  const now = new Date();
  dateEl.textContent = now.toLocaleDateString('en-US', {
    weekday: 'long', month: 'long', day: 'numeric', year: 'numeric'
  });

  // Phase 1 state — show pending indicators in each lane column
  LANES.forEach(lane => {
    const msgs = document.getElementById(`messages-${lane.id}`);
    const hint = msgs.querySelector('.empty-hint');
    if (hint) hint.remove();
    const pending = document.createElement('div');
    pending.className = 'message agent';
    pending.id = `standup-pending-${lane.id}`;
    pending.innerHTML = `<div class="bubble"><span class="standup-label">STANDUP</span><span class="cursor"></span></div>`;
    msgs.appendChild(pending);
    scrollBottom(msgs);
  });

  btn.disabled = true;
  btn.textContent = 'GATHERING...';

  // Phase 2 overlay — waiting state
  content.innerHTML = '<div class="standup-waiting">Collecting lane reports<span class="cursor"></span></div>';
  let synthesisBuffer = '';

  try {
    const res = await fetch('/api/standup', { method: 'POST' });
    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let phase1Done = false;

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      const raw = decoder.decode(value, { stream: true });
      const lines = raw.split('\n');

      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        let data;
        try { data = JSON.parse(line.slice(6)); } catch { continue; }

        // Phase 1 — lane report arrived
        if (data.phase === 1 && data.lane && data.report) {
          const pending = document.getElementById(`standup-pending-${data.lane}`);
          if (pending) {
            const bubble = pending.querySelector('.bubble');
            bubble.innerHTML = `<span class="standup-label">STANDUP</span>${renderMarkdown(data.report)}`;
          }
          const msgs = document.getElementById(`messages-${data.lane}`);
          if (msgs) scrollBottom(msgs);
        }

        // Phase 2 — synthesis streaming
        if (data.phase === 2 && data.text) {
          if (!phase1Done) {
            phase1Done = true;
            overlay.style.display = 'flex';
            content.innerHTML = '';
          }
          synthesisBuffer += data.text;
          content.innerHTML = renderMarkdown(synthesisBuffer) + '<span class="cursor"></span>';
          content.scrollTop = content.scrollHeight;
        }

        if (data.saved) {
          const footer = document.getElementById('standupFooter');
          if (footer) {
            footer.innerHTML = `<span class="saved-badge">✓ Saved — <code>${data.saved}</code></span>`;
          }
        }

        if (data.done) {
          // Final clean render — no cursor
          content.innerHTML = renderMarkdown(synthesisBuffer);
          content.scrollTop = 0;
        }
      }
    }
  } catch (err) {
    // Clean up pending indicators on error
    LANES.forEach(lane => {
      const p = document.getElementById(`standup-pending-${lane.id}`);
      if (p) p.remove();
    });
    content.innerHTML = `<em style="color:#f43f5e">Error: ${err.message}</em>`;
    overlay.style.display = 'flex';
  } finally {
    btn.disabled = false;
    btn.textContent = 'STANDUP';
  }
}

function closeStandup() {
  document.getElementById('standupOverlay').style.display = 'none';
}

function overlayClickOutside(e) {
  if (e.target === document.getElementById('standupOverlay')) closeStandup();
}

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeStandup();
});

// ── History restore ───────────────────────────────────────────────────────────
function addHistoricalMessage(laneId, role, text) {
  const msgs = document.getElementById(`messages-${laneId}`);
  const hint = msgs.querySelector('.empty-hint');
  if (hint) hint.remove();

  const div = document.createElement('div');
  if (role === 'user') {
    div.className = 'message user';
    div.innerHTML = `<div class="bubble">${escapeHtml(text)}</div>`;
  } else {
    div.className = 'message agent';
    div.innerHTML = `<div class="bubble"><div class="tool-actions"></div><div class="agent-text">${renderMarkdown(text)}</div></div>`;
  }
  div.dataset.historical = '1';
  msgs.appendChild(div);
}

async function loadHistory(laneId) {
  try {
    const res = await fetch(`/api/history/${laneId}`);
    if (!res.ok) return;
    const messages = await res.json();
    if (!messages.length) return;

    const msgs = document.getElementById(`messages-${laneId}`);

    // Add a subtle divider before historical messages
    const divider = document.createElement('div');
    divider.className = 'history-divider';
    divider.textContent = `${messages.length} previous messages`;
    msgs.querySelector('.empty-hint')?.remove();
    msgs.appendChild(divider);

    for (const msg of messages) {
      addHistoricalMessage(laneId, msg.role, msg.text);
    }

    // Scroll to bottom so newest messages are visible
    msgs.scrollTop = msgs.scrollHeight;
  } catch {}
}

// ── Vault status ──────────────────────────────────────────────────────────────
async function pollStatus() {
  try {
    const res = await fetch('/api/status');
    const data = await res.json();
    document.getElementById('vaultStatus').textContent =
      `${data.notes} notes in vault`;
  } catch {
    document.getElementById('vaultStatus').textContent = 'vault offline';
  }
}

// ── Init ──────────────────────────────────────────────────────────────────────
buildUI();
LANES.forEach(lane => loadHistory(lane.id));
pollStatus();
setInterval(pollStatus, 30000);
</script>
</body>
</html>
